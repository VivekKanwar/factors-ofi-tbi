<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-09-25">

<title>project-plan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="project-plan_files/libs/clipboard/clipboard.min.js"></script>
<script src="project-plan_files/libs/quarto-html/quarto.js"></script>
<script src="project-plan_files/libs/quarto-html/popper.min.js"></script>
<script src="project-plan_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="project-plan_files/libs/quarto-html/anchor.min.js"></script>
<link href="project-plan_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="project-plan_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="project-plan_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="project-plan_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="project-plan_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">project-plan</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- The project plan should be 3-4 pages long and written in
Rmarkdown (like this document). Remove all comments in italic when you 
use this document as a template for your own project plan. -->
<!-- This is an R Markdown document. Markdown is a simple formatting
syntax for authoring HTML, PDF, and MS Word documents. For more
details on using R Markdown see http://rmarkdown.rstudio.com -->
<!-- This is a comment and will not be present in the compiled
document. Try "knitting" this document by clicking the knit button up
to the left, or by running `rmarkdown::render("project-plan.Rmd")` in
the console and you should only see headings -->
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Injury has reached epidemic proportions worldwide, disproportionately affecting the most productive and the youngest members of society. Trauma, often synonymously used with serious injury, is defined as a physical injury and the body’s associated response <span class="citation" data-cites="Szolnoky2025">(<a href="#ref-Szolnoky2025" role="doc-biblioref">1</a>)</span>. Furthermore, trauma remains a leading cause of death and disability worldwide, where it is the foremost cause of death among people under the age of 45 and ranks as the fourth leading cause of death across all ages <span class="citation" data-cites="Maerz2009">(<a href="#ref-Maerz2009" role="doc-biblioref">2</a>)</span>.</p>
<section id="pathophysiology" class="level2">
<h2 class="anchored" data-anchor-id="pathophysiology">Pathophysiology</h2>
<p>Among trauma-related conditions, traumatic brain injury (TBI) is a major cause of death and disability worldwide and constitutes a significant public health burden. (3) TBI is the result of an external force causing neurological impairments that may be either transient or permanent. (4) Furthermore, TBI should not be regarded as a single event but rather as a dynamic process. The initial trauma is followed by secondary pathophysiological cascades, including ischemia, oedema, and metabolic disturbances, that develop over time and critically influence long-term outcomes. (5) As such, patients affected often require admission to the intensive care unit (ICU).</p>
</section>
<section id="management-of-tbi" class="level2">
<h2 class="anchored" data-anchor-id="management-of-tbi">Management of TBI</h2>
<p>Initial management of TBI spans prehospital and early in-hospital phases and centres on rapid physiological stabilisation and diagnostics in order for secondary injuries to be limited. Protection of the airway in patients with impaired consciousness, adequate oxygenation and normocapnia, and fast correction of hypotension are all prioritised in the initial phase of management as hypoxia and low blood pressures are associated with an increased mortality (6–9). Non-contrast head CT should be performed without delay to identify surgically remediable lesions. Depending on mechanism and physiology, whole-body CT may be used selectively, as randomised data show no mortality advantage over targeted imaging, while observational work underscores the benefit of immediate CT pathways for severely injured patients (10,11). Haemostatic strategies in the early stages, such as administering tranexamic acid within three hours of injury, can reduce mortality (12). After this initial phase, depending on the patient’s condition, management transitions to other areas of the hospital, where sustained prevention of secondary systemic and intracranial insults becomes the primary focus.</p>
<p>The management of TBI in the ICU is particularly challenging. Given the heterogeneity and dynamic nature of the condition, care must prioritise the prevention and limitation of secondary systemic threats such as hypoxia, hypercapnia, arterial hypotension, hyponatraemia and pyrexia. Equal attention must also be directed toward secondary intracranial threats, including expanding haematomas, cerebral contusions and rises in intracranial pressure. (5–7) Although these complexities are often anticipated, they render ICU care especially vulnerable to deviations from optimal practice, thereby posing risks to both patient safety and overall quality of care.</p>
<p>The intensive care of patients with TBI has been addressed in both guidelines and reviews. Multiple recent reviews and guideline updates consistently refer to the Brain Trauma Foundation (BTF) Fourth Edition, which remains a central reference for modern management (5–9). According to the BTF, treatment should be initiated when intracranial pressure (ICP) exceeds 22 mmHg. Cerebral perfusion pressure (CPP) should be maintained between 60–70 mmHg. Prophylactic hyperventilation should be avoided within the first 24 hours, and corticosteroid usage should be refrained from.</p>
<p>(At Karolinska University Hospital, the setting for this study, similar principles are seen in the Traumahandboken. For severe TBI, defined as GCS &lt; 8, early airway protection with intubation in unconscious patients, rapid CT imaging, timely administration of tranexamic acid, and early neurosurgical consultation are recommended. In cases where there are signs of impending herniation, the handbook advises measures such as controlled hyperventilation and osmotherapy with mannitol or hypertonic saline. All this is always in conjunction with urgent neurosurgical evaluation. (Källa Karolinska handboken)) <!-- Remove paragraph? --></p>
</section>
<section id="trauma-quality-improvement" class="level2">
<h2 class="anchored" data-anchor-id="trauma-quality-improvement">Trauma Quality Improvement</h2>
<p>Despite the presence of systems and guidelines in place for these patients, trauma care remains vulnerable to errors, deviations from established practice, and treatment delays, all of which may negatively influence outcomes. In response, the American College of Surgeons developed the Trauma Quality Improvement Program (TQIP), a risk-adjusted benchmarking system designed to assess the quality of trauma care. Through audit filters and peer review, it identifies opportunities for improvement (OFI) and ultimately reduces trauma-related mortality (10,11). Previous studies and reviews have discussed preventable trauma deaths where recurring patterns occur, namely, delays in imaging and care, missed injuries, deviations in care regarding airway-related care, haemorrhage control, and fluid management (12–16). Importantly, some of these findings were observed in high-performing level I trauma centres, underscoring that even mature systems remain vulnerable to error. Furthermore, injuries to the central nervous system account for a substantial proportion of trauma-related deaths, as demonstrated in analyses from large registries such as the Arkansas Trauma Registry (16). Yet, while previous research has described OFI in trauma resuscitation and in general ICU trauma cohorts, relatively little is known about the prevalence, nature, and determinants of OFI specifically among patients with TBI. <!-- Add a part after ACS TQIP using WHO as a reference to TQIP--></p>
<p>Previous papers at Karolinska University Hospital have contributed to this field by describing OFIs across different aspects of trauma care. In 2023, Hussein A. et al.&nbsp;analysed patient- and process-related factors during trauma resuscitation and concluded that variables such as time to first CT and injury severity were strongly associated with OFI (17). Cao ES. et al.&nbsp;continued the focus on ICU cohorts, presenting that 9.9% ICU-admitted adult trauma patients experienced at least one OFI (1). Most recently, Szolnoky K et al.&nbsp;assessed OFI patterns in trauma cohorts and demonstrated that, although overall incidence declined over time, patients with TBI remained likely to have preventable shortcomings in care (18). <!-- Rewrite into a more general rationale paragraph--></p>
</section>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="study-design" class="level2">
<h2 class="anchored" data-anchor-id="study-design">Study Design</h2>
<p>A single-centre, registry-based retrospective cohort study was conducted at Karolinska University Hospital in Solna (NKS). The trauma registry for NKS is a comprehensive trauma registry that reports to the Swedish National Trauma Registry, SweTrau, and is compliant with the Utstein template for uniform reporting after trauma (Källa Utstein Template). As such, the registry prospectively records patient demographics, prehospital and emergency department physiology, times of key interventions such as imaging, surgery and transfer, injury severity scores, and in-hospital outcome.</p>
<p>The Swedish Trauma Registry includes patients of all ages who have sustained serious injuries from traumatic events such as falls, traffic incidents, or other external violence. Since 2024 , patients have been included if a trauma team activation has occurred, regardless of injury severity, or if they have a New Injury Severity Score (NISS) greater than fifteen without trauma team activation. Patients transferred to a hospital within seven days of the traumatic event with a NISS greater than fifteen are also included. Exclusion criteria are cases where the only traumatic condition is chronic subdural haematoma, trauma alarms without an underlying traumatic event, patients with protected identity, and patients declared dead on arrival. Since these inclusion and exclusion criteria have changed over time, patients in this study will be filtered to ensure they fulfil the criteria relevant to the study period (Källa SweTrau årsbok 2024). <!--Use the 2023 version instead? Data is up to 2023 --></p>
<p>To identify opportunities for improvement, the trauma registry was linked to the hospital’s local trauma care quality database. Linkage was performed using the Swedish personal identity number, after which trauma registry variables and quality review outcomes were extracted for analysis of patient and process factors associated with opportunities for improvement.</p>
</section>
<section id="setting" class="level2">
<h2 class="anchored" data-anchor-id="setting">Setting</h2>
<p>Karolinska University Hospital in Solna houses Trauma Centre Karolinska (TCK), Sweden’s largest provider of advanced trauma care for both adults and children. According to the definition of the American College of Surgeons, Karolinska University Hospital in Solna serves as the designated Level 1 trauma centre for the greater metropolitan area of Stockholm. This designation requires around-the-clock availability of key services, including neurosurgery, general surgery, orthopaedic surgery, anaesthesia and intensive care, as well as diagnostic and interventional radiology and consultants from other relevant specialities. (Källa från American College of surgeons, plus källa som säger NKS har alla dessa saker). Also, the ICU units in Karolinska Universitets sjukhuset are all recognised as Level 3 units per the Svenska Föreningen för Anestesi och Intensivvård. (källa )</p>
<p>Furthermore, the trauma registry includes about 14000 patients admitted between 2012 and 2023. The trauma care quality database is a subset of this registry, encompassing approximately 8,000 patients selected for review between 2014 and 2023. Screening for potential opportunities for improvement was implemented in 2013 for selected patient cases. Initially, case selection was based on a limited number of audit filters and the judgment of a small group of clinicians directly involved in trauma care. Since 2017, a standardised set of audit filters has been consistently applied, and all trauma patients admitted to the hospital are screened for potential opportunities for improvement. The process has expanded to include a broader group of senior clinicians and nursing staff, ensuring a systematic and comprehensive review. Patients flagged through the audit filters, and therefore have potential OFI, undergo discussion in structured multidisciplinary morbidity and mortality conferences, where representatives from relevant specialties and professions involved in trauma care are involved. The discussion focuses on establishing whether there were any preventable events or deviations from standards of practice. The final classification of whether an opportunity for improvement is present is determined by consensus among the peer-review group. As such, subjectivity is minimised and ensures that decisions reflect a collective judgement. Whether or not an OFI is identified, the decision of the review is recorded in the trauma care quality database, ensuring systematic documentation of positive findings and cases without deviations.</p>
</section>
<section id="participants" class="level2">
<h2 class="anchored" data-anchor-id="participants">Participants</h2>
<p>Included in the study were all adult patients with TBI recorded in the Karolinska trauma registry between 2012 and 2023 who also had been screened for opportunity for improvements. Furthermore, TBI was defined as (a GCS score of ≤8 combined with an Abbreviated Injury Scale ≥3 for the head region …. ) Patients were eligible irrespective of level <!-- Definition found in Elins paper, same applies?--> of care and were not restricted to intensive care admissions.</p>
<p>Patients younger than 18 years were excluded, as their trauma follows separate clinical care systems and quality <!-- is this true? could not fins source--> review processes that differ from those for adults . Also excluded were patients declared dead on arrival, since assessment of opportunities for improvement in these cases is not relevant to the aim of this study.</p>
</section>
<section id="variables" class="level2">
<h2 class="anchored" data-anchor-id="variables">Variables</h2>
<p>Outcome</p>
<p>The primary outcome of this study was the presence of one or more opportunities for improvement during the management of patients with TBI. As mentioned, OFIs were adjudicated after a screening process with audit filters and a subsequent review in multidisciplinary morbidity-and-mortality conferences. Following the peer review, the result of each case discussion was recorded in the trauma care quality register and was presented as a binary variable, “Yes - At least one OFI identified” and “No - No OFI identified”.</p>
<p>Patient factors and processes</p>
<p>The variables chosen to be analysed for this study were those from the trauma registry, based on the locally used audit filters, standard epidemiological factors and the factors registered in the Swedish National Trauma Registry. These could be divided into categorical and continuous variables.</p>
<p>Certain continuous variables were retained in their continuous form for analysis, but others were categorised into clinically meaningful groups to facilitate descriptive statistics and subgroup analyses. The continuous variables include…<br>
And those who were categorised were….</p>
<p>Furthermore, the categorical variables include… <!-- Choose variables, not sure which too chose--></p>
</section>
<section id="statistical-methods" class="level2">
<h2 class="anchored" data-anchor-id="statistical-methods">Statistical methods</h2>
<!-- *Refer to the appropriate reporting guideline for details. If you are
developing, updating or validating a clinical prediction model then
use
[TRIPOD](https://www.equator-network.org/reporting-guidelines/tripod-statement/). If
you are conducting an observational study, for example a cohort or
case control study in which you assess associations between some
exposure and an outcome then use
[STROBE](https://www.equator-network.org/reporting-guidelines/strobe/).* -->
</section>
</section>
<section id="project-update-and-timeline" class="level1">
<h1>Project Update and Timeline</h1>
<p><em>This is part B) in the project plan [sv: projektredogörelse]. </em></p>
<p><em>Save the image generated from the Gantt chard spreadsheet into the assets folder, rename it to project-gantt.png</em></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/project-gantt.png" class="img-fluid figure-img"></p>
<figcaption><strong>The Gantt chart will be displayed here when you place it in the assets folder under “project-gantt.png”</strong></figcaption>
</figure>
</div>
</section>
<section id="back-up-plan" class="level1">
<h1>Back-up Plan</h1>
<p><em>This is part C) in the project plan [sv: projektredogörelse]</em></p>
</section>
<section id="references" class="level1">

<!-- Do not edit by hand, references will be inserted and formatted automatically once you knit this document -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" role="list">
<div id="ref-Szolnoky2025" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Szolnoky K, Joneborg E, Attergrim J, Albaaj H, Strömmer L, Brattström O, et al. <a href="https://doi.org/10.1136/tsaco-2024-001676">Incidence of opportunities for improvement in trauma patient care: A retrospective registry-based study</a>. Trauma Surgery &amp; Acute Care Open. 2025 May;10(2):e001676. </div>
</div>
<div id="ref-Maerz2009" class="csl-entry" role="listitem">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">Maerz LL, Davis KA, Rosenbaum SH. Trauma. Int Anesthesiol Clin. 2009;47(1):25–36. </div>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>